"""
Claude AI ì„œë¹„ìŠ¤
íŽ˜ë¥´ì†Œë‚˜ë³„ ë§žì¶¤í˜• ë¬¸ì„œ ìš”ì•½ ìƒì„±
"""

import httpx
import os
from typing import Dict, Any
import json

class ClaudeService:
    def __init__(self):
        self.api_key = os.getenv("ANTHROPIC_API_KEY", "")
        self.api_url = "https://api.anthropic.com/v1/messages"
        self.model = "claude-3-haiku-20240307"  # Fast and cost-effective for MVP
        
        # íŽ˜ë¥´ì†Œë‚˜ë³„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
        self.persona_prompts = {
            "developer": {
                "name": "ê°œë°œìž",
                "description": "ê¸°ìˆ ì  êµ¬í˜„ì— ì§‘ì¤‘í•˜ëŠ” ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìž",
                "focus_areas": [
                    "ê¸°ìˆ ì  ìš”êµ¬ì‚¬í•­ ë° ì œì•½ì‚¬í•­",
                    "API ëª…ì„¸ ë° ë°ì´í„° êµ¬ì¡°",
                    "êµ¬í˜„ ë°©ë²• ë° ê¸°ìˆ  ìŠ¤íƒ",
                    "ì„±ëŠ¥ ë° ë³´ì•ˆ ê³ ë ¤ì‚¬í•­",
                    "ì½”ë“œ ê´€ë ¨ ê°€ì´ë“œë¼ì¸"
                ],
                "prompt_template": """ë‹¹ì‹ ì€ ê²½í—˜ ë§Žì€ ê°œë°œìžìž…ë‹ˆë‹¤. ë‹¤ìŒ Confluence ë¬¸ì„œë¥¼ ê°œë°œìž ê´€ì ì—ì„œ ìš”ì•½í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ ì˜ì—­ì— íŠ¹ížˆ ì§‘ì¤‘í•´ì„œ ìš”ì•½í•´ì£¼ì„¸ìš”:
- ê¸°ìˆ ì  ìš”êµ¬ì‚¬í•­ ë° ì œì•½ì‚¬í•­
- API ëª…ì„¸ ë° ë°ì´í„° êµ¬ì¡°
- êµ¬í˜„ ë°©ë²• ë° ê¸°ìˆ  ìŠ¤íƒ
- ì„±ëŠ¥ ë° ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- ì½”ë“œ ê´€ë ¨ ê°€ì´ë“œë¼ì¸

ë¬¸ì„œ ë‚´ìš©ì—ì„œ ê°œë°œê³¼ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ì´ ì—†ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì „ëžµì´ë‚˜ ë§ˆì¼€íŒ… ê´€ë ¨ ë‚´ìš©ì€ ê°„ëžµížˆ ì–¸ê¸‰í•˜ê±°ë‚˜ ìƒëžµí•´ë„ ë©ë‹ˆë‹¤.

ìš”ì•½ì€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”:
## ðŸ”§ ê¸°ìˆ  ìš”ì•½
## ðŸ“‹ êµ¬í˜„ ìš”êµ¬ì‚¬í•­
## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œì•½
## ðŸ“Š ì„±ëŠ¥/ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

ë¬¸ì„œ ì œëª©: {title}

ë¬¸ì„œ ë‚´ìš©:
{content}"""
            },
            
            "product_manager": {
                "name": "ê¸°íšìž/í”„ë¡œë•íŠ¸ ë§¤ë‹ˆì €",
                "description": "ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œì™€ ì œí’ˆ ì „ëžµì— ì§‘ì¤‘í•˜ëŠ” ê¸°íšìž",
                "focus_areas": [
                    "ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œ ë° ì „ëžµ",
                    "ì¼ì • ë° ë§ˆì¼ìŠ¤í†¤",
                    "ë¦¬ìŠ¤í¬ ë° ì´ìŠˆì‚¬í•­",
                    "ì˜ì‚¬ê²°ì • í¬ì¸íŠ¸",
                    "ì´í•´ê´€ê³„ìž ë° ì»¤ë®¤ë‹ˆì¼€ì´ì…˜"
                ],
                "prompt_template": """ë‹¹ì‹ ì€ ê²½í—˜ ë§Žì€ í”„ë¡œë•íŠ¸ ë§¤ë‹ˆì €ìž…ë‹ˆë‹¤. ë‹¤ìŒ Confluence ë¬¸ì„œë¥¼ ê¸°íšìž/PM ê´€ì ì—ì„œ ìš”ì•½í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ ì˜ì—­ì— íŠ¹ížˆ ì§‘ì¤‘í•´ì„œ ìš”ì•½í•´ì£¼ì„¸ìš”:
- ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œ ë° ì „ëžµ
- ì¼ì • ë° ë§ˆì¼ìŠ¤í†¤
- ë¦¬ìŠ¤í¬ ë° ì´ìŠˆì‚¬í•­
- ì˜ì‚¬ê²°ì • í¬ì¸íŠ¸
- ì´í•´ê´€ê³„ìž ë° ì»¤ë®¤ë‹ˆì¼€ì´ì…˜

ê¸°ìˆ ì ì¸ ì„¸ë¶€ êµ¬í˜„ ë‚´ìš©ë³´ë‹¤ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ìž„íŒ©íŠ¸ì™€ í”„ë¡œì íŠ¸ ê´€ë¦¬ ê´€ì ì—ì„œ ì¤‘ìš”í•œ ì •ë³´ì— ì§‘ì¤‘í•´ì£¼ì„¸ìš”.

ìš”ì•½ì€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”:
## ðŸŽ¯ ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œ
## ðŸ“… ì£¼ìš” ì¼ì • ë° ë§ˆì¼ìŠ¤í†¤
## âš ï¸ ë¦¬ìŠ¤í¬ ë° ì´ìŠˆ
## ðŸ¤ ì˜ì‚¬ê²°ì • í¬ì¸íŠ¸

ë¬¸ì„œ ì œëª©: {title}

ë¬¸ì„œ ë‚´ìš©:
{content}"""
            },
            
            "designer": {
                "name": "UX/UI ë””ìžì´ë„ˆ",
                "description": "ì‚¬ìš©ìž ê²½í—˜ê³¼ ì¸í„°íŽ˜ì´ìŠ¤ ë””ìžì¸ì— ì§‘ì¤‘í•˜ëŠ” ë””ìžì´ë„ˆ",
                "focus_areas": [
                    "ì‚¬ìš©ìž ê²½í—˜ ë° ì¸í„°íŽ˜ì´ìŠ¤",
                    "ë””ìžì¸ ìš”êµ¬ì‚¬í•­ ë° ê°€ì´ë“œë¼ì¸",
                    "ì‚¬ìš©ìž ë¦¬ì„œì¹˜ ë° í”¼ë“œë°±",
                    "ì¸í„°ëž™ì…˜ ë° í”Œë¡œìš°",
                    "ë¸Œëžœë”© ë° ë¹„ì£¼ì–¼ ìš”ì†Œ"
                ],
                "prompt_template": """ë‹¹ì‹ ì€ ê²½í—˜ ë§Žì€ UX/UI ë””ìžì´ë„ˆìž…ë‹ˆë‹¤. ë‹¤ìŒ Confluence ë¬¸ì„œë¥¼ ë””ìžì´ë„ˆ ê´€ì ì—ì„œ ìš”ì•½í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ ì˜ì—­ì— íŠ¹ížˆ ì§‘ì¤‘í•´ì„œ ìš”ì•½í•´ì£¼ì„¸ìš”:
- ì‚¬ìš©ìž ê²½í—˜ ë° ì¸í„°íŽ˜ì´ìŠ¤ ìš”êµ¬ì‚¬í•­
- ë””ìžì¸ ê°€ì´ë“œë¼ì¸ ë° ìŠ¤íƒ€ì¼
- ì‚¬ìš©ìž ë¦¬ì„œì¹˜ ë° í”¼ë“œë°±
- ì¸í„°ëž™ì…˜ ë° ì‚¬ìš©ìž í”Œë¡œìš°
- ë¸Œëžœë”© ë° ë¹„ì£¼ì–¼ ìš”ì†Œ

ê¸°ìˆ ì ì¸ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ì´ë‚˜ ë³µìž¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë³´ë‹¤ëŠ” ì‚¬ìš©ìž ê´€ì ê³¼ ë””ìžì¸ ê´€ë ¨ ë‚´ìš©ì— ì§‘ì¤‘í•´ì£¼ì„¸ìš”.

ìš”ì•½ì€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”:
## ðŸŽ¨ UX/UI ìš”êµ¬ì‚¬í•­
## ðŸ‘¥ ì‚¬ìš©ìž ê´€ì 
## ðŸ“± ì¸í„°íŽ˜ì´ìŠ¤ ê°€ì´ë“œë¼ì¸
## ðŸ”„ ì‚¬ìš©ìž í”Œë¡œìš°

ë¬¸ì„œ ì œëª©: {title}

ë¬¸ì„œ ë‚´ìš©:
{content}"""
            }
        }

    async def generate_summary(self, content: str, persona: str, title: str = "") -> str:
        """
        íŽ˜ë¥´ì†Œë‚˜ë³„ ë§žì¶¤í˜• ìš”ì•½ ìƒì„±
        """
        try:
            if not self.api_key:
                # API í‚¤ê°€ ì—†ì„ ë•ŒëŠ” Mock ìš”ì•½ ë°˜í™˜ (ê°œë°œìš©)
                return self._generate_mock_summary(persona, title)
            
            # íŽ˜ë¥´ì†Œë‚˜ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
            persona_config = self.persona_prompts.get(persona)
            if not persona_config:
                raise Exception(f"ì§€ì›í•˜ì§€ ì•ŠëŠ” íŽ˜ë¥´ì†Œë‚˜: {persona}")
            
            # í”„ë¡¬í”„íŠ¸ ìƒì„±
            prompt = persona_config["prompt_template"].format(
                title=title or "ì œëª© ì—†ìŒ",
                content=content[:4000]  # Claude í† í° ì œí•œ ê³ ë ¤
            )
            
            # Claude API í˜¸ì¶œ
            headers = {
                "x-api-key": self.api_key,
                "Content-Type": "application/json",
                "anthropic-version": "2023-06-01"
            }
            
            payload = {
                "model": self.model,
                "max_tokens": 1000,
                "messages": [
                    {
                        "role": "user",
                        "content": prompt
                    }
                ]
            }
            
            async with httpx.AsyncClient(timeout=30.0) as client:
                response = await client.post(
                    self.api_url,
                    headers=headers,
                    json=payload
                )
                
                if response.status_code == 200:
                    result = response.json()
                    return result["content"][0]["text"]
                else:
                    # API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ Mock ìš”ì•½ ë°˜í™˜
                    return self._generate_mock_summary(persona, title)
                    
        except Exception as e:
            # ì˜¤ë¥˜ ë°œìƒ ì‹œ Mock ìš”ì•½ ë°˜í™˜
            return self._generate_mock_summary(persona, title)

    def _generate_mock_summary(self, persona: str, title: str) -> str:
        """Mock ìš”ì•½ ìƒì„± (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)"""
        
        persona_config = self.persona_prompts.get(persona, self.persona_prompts["developer"])
        persona_name = persona_config["name"]
        
        mock_summaries = {
            "developer": f"""## ðŸ”§ ê¸°ìˆ  ìš”ì•½
{title or 'ConfluSum í”„ë¡œì íŠ¸'}ëŠ” FastAPIì™€ Claude AIë¥¼ í™œìš©í•œ ë¬¸ì„œ ìš”ì•½ ì„œë¹„ìŠ¤ìž…ë‹ˆë‹¤.

## ðŸ“‹ êµ¬í˜„ ìš”êµ¬ì‚¬í•­
- **Backend**: FastAPI (Python) - REST API ì„œë²„ êµ¬ì¶•
- **Frontend**: HTML/CSS/JavaScript - ë°˜ì‘í˜• ì›¹ ì¸í„°íŽ˜ì´ìŠ¤
- **AI Integration**: Claude APIë¥¼ í†µí•œ ìžì—°ì–´ ì²˜ë¦¬
- **Database**: í”¼ë“œë°± ë°ì´í„° ì €ìž¥ìš© ê²½ëŸ‰ DB

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œì•½
- Claude API í† í° ì œí•œ: ìš”ì²­ë‹¹ ìµœëŒ€ 4,000 í† í°
- Confluence API ì¸ì¦: Basic Auth ë˜ëŠ” API Token í•„ìš”
- CORS ì„¤ì •: í”„ë¡ íŠ¸ì—”ë“œ-ë°±ì—”ë“œ í†µì‹ ì„ ìœ„í•œ ì ì ˆí•œ CORS ì •ì±…

## ðŸ“Š ì„±ëŠ¥/ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- ì‘ë‹µ ì‹œê°„ ëª©í‘œ: í‰ê·  30ì´ˆ ì´ë‚´
- API í‚¤ ë³´ì•ˆ: í™˜ê²½ë³€ìˆ˜ë¥¼ í†µí•œ ë¯¼ê°ì •ë³´ ê´€ë¦¬
- ì—ëŸ¬ í•¸ë“¤ë§: ì‚¬ìš©ìž ì¹œí™”ì  ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ""",

            "product_manager": f"""## ðŸŽ¯ ë¹„ì¦ˆë‹ˆìŠ¤ ëª©í‘œ
{title or 'ConfluSum í”„ë¡œì íŠ¸'}ëŠ” ê¸°ì—… ë‚´ ë¬¸ì„œ ì²˜ë¦¬ íš¨ìœ¨ì„±ì„ 90% í–¥ìƒì‹œí‚¤ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

## ðŸ“… ì£¼ìš” ì¼ì • ë° ë§ˆì¼ìŠ¤í†¤
- **Day 1**: MVP ê°œë°œ ì™„ë£Œ ë° ë‚´ë¶€ í…ŒìŠ¤íŠ¸
- **Week 1**: ë² íƒ€ í…ŒìŠ¤íŠ¸ (10ëª… ëŒ€ìƒ) ë° í”¼ë“œë°± ìˆ˜ì§‘
- **Month 1**: ì‚¬ìš©ìž í”¼ë“œë°± ë¶„ì„ í›„ ê°œì„ ì‚¬í•­ ë°˜ì˜
- **Month 3**: 500ëª… í™œì„± ì‚¬ìš©ìž í™•ë³´ ëª©í‘œ

## âš ï¸ ë¦¬ìŠ¤í¬ ë° ì´ìŠˆ
- **ê¸°ìˆ  ë¦¬ìŠ¤í¬**: Claude API ì˜ì¡´ì„±ìœ¼ë¡œ ì¸í•œ ì„œë¹„ìŠ¤ ì•ˆì •ì„±
- **ì‹œìž¥ ë¦¬ìŠ¤í¬**: ì‚¬ìš©ìž ë‹ˆì¦ˆ ê²€ì¦ í•„ìš” (70% ì´ìƒ ë§Œì¡±ë„ ëª©í‘œ)
- **ê²½ìŸ ë¦¬ìŠ¤í¬**: ëŒ€ê¸°ì—…ì˜ ìœ ì‚¬ ì„œë¹„ìŠ¤ ì¶œì‹œ ê°€ëŠ¥ì„±

## ðŸ¤ ì˜ì‚¬ê²°ì • í¬ì¸íŠ¸
- **Go/No-Go ê²°ì •**: 1ì£¼ì¼ í›„ ë² íƒ€ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê¸°ë°˜
- **ì„±ê³µ ê¸°ì¤€**: 70% ì´ìƒ ê¸ì • í”¼ë“œë°±, 30ì´ˆ ì´ë‚´ ì‘ë‹µì‹œê°„
- **ì‹¤íŒ¨ ê¸°ì¤€**: 50% ì´í•˜ ë§Œì¡±ë„ ì‹œ í”„ë¡œì íŠ¸ í”¼ë²— ê²€í† """,

            "designer": f"""## ðŸŽ¨ UX/UI ìš”êµ¬ì‚¬í•­
{title or 'ConfluSum í”„ë¡œì íŠ¸'}ëŠ” ì§ê´€ì ì¸ 3ë‹¨ê³„ ì‚¬ìš©ìž í”Œë¡œìš°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ðŸ‘¥ ì‚¬ìš©ìž ê´€ì 
- **ì£¼ ì‚¬ìš©ìž**: ì¤‘ì†Œ IT ê¸°ì—…ì˜ ê°œë°œìž, ê¸°íšìž, ë””ìžì´ë„ˆ
- **ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤**: ê¸´ Confluence ë¬¸ì„œë¥¼ ì—­í• ì— ë§žê²Œ ë¹ ë¥´ê²Œ íŒŒì•…
- **ì‚¬ìš©ìž ë‹ˆì¦ˆ**: ë³µìž¡í•œ ì„¤ì • ì—†ì´ URLë§Œìœ¼ë¡œ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥

## ðŸ“± ì¸í„°íŽ˜ì´ìŠ¤ ê°€ì´ë“œë¼ì¸
- **ë””ìžì¸ ì›ì¹™**: ë‹¨ìˆœí•¨, ëª…í™•ì„±, ì ‘ê·¼ì„±
- **ìƒ‰ìƒ**: ì°¨ë¶„í•œ ë¸”ë£¨ ê³„ì—´ (#3498db) ë©”ì¸ ì»¬ëŸ¬
- **íƒ€ì´í¬ê·¸ëž˜í”¼**: ì‹œìŠ¤í…œ í°íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ê°€ë…ì„± ìµœì í™”
- **ë°˜ì‘í˜•**: ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ëª¨ë“  í™˜ê²½ì—ì„œ ì¼ê´€ëœ ê²½í—˜

## ðŸ”„ ì‚¬ìš©ìž í”Œë¡œìš°
1. **URL ìž…ë ¥**: Confluence ë¬¸ì„œ ë§í¬ ë¶™ì—¬ë„£ê¸°
2. **íŽ˜ë¥´ì†Œë‚˜ ì„ íƒ**: ì§ê´€ì ì¸ ì¹´ë“œ í˜•íƒœ ì¸í„°íŽ˜ì´ìŠ¤
3. **ìš”ì•½ í™•ì¸**: ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ê²°ê³¼ í‘œì‹œ
4. **í”¼ë“œë°± ì œê³µ**: ê°„ë‹¨í•œ ðŸ‘/ðŸ‘Ž ë²„íŠ¼ìœ¼ë¡œ ë§Œì¡±ë„ ìˆ˜ì§‘"""
        }
        
        return mock_summaries.get(persona, mock_summaries["developer"])

    def get_persona_info(self, persona: str) -> Dict[str, Any]:
        """íŽ˜ë¥´ì†Œë‚˜ ì •ë³´ ë°˜í™˜"""
        return self.persona_prompts.get(persona, {})